-- ===================================================
-- 커버드 콜 익스플로러 데이터베이스 재구축 스크립트
-- 증권사 CSV 파일 기반으로 정확한 데이터 재입력
-- ===================================================

-- 기존 데이터 삭제 (외래키 순서에 따라)
DELETE FROM dividends;
DELETE FROM transactions;
DELETE FROM holdings;
DELETE FROM exchange_rates;

-- 1. 환율 데이터 입력 (exchange_rates 테이블)
-- wonList.csv와 dollorList.csv에서 환전 거래의 환율 정보 추출
INSERT INTO exchange_rates (timestamp, usd_krw, source) VALUES
('2025-04-16 09:00:00', 1430.06, 'CSV-IMPORT'),
('2025-04-23 09:00:00', 1432.89, 'CSV-IMPORT'),
('2025-04-25 09:00:00', 1450.77, 'CSV-IMPORT'),
('2025-05-28 09:00:00', 1373.19, 'CSV-IMPORT'),
('2025-06-28 09:00:00', 1374.04, 'CSV-IMPORT'),
('2025-07-02 09:00:00', 1359.03, 'CSV-IMPORT'),
('2025-07-14 09:00:00', 1391.84, 'CSV-IMPORT'),
('2025-07-17 09:00:00', 1392.70, 'CSV-IMPORT'),
('2025-07-22 09:00:00', 1395.54, 'CSV-IMPORT'),
('2025-07-23 09:00:00', 1384.49, 'CSV-IMPORT'),
('2025-07-24 09:00:00', 1382.73, 'CSV-IMPORT');

-- 2. 거래 데이터 입력 (transactions 테이블)
-- dollorList.csv의 구매/판매 거래 기반
INSERT INTO transactions (date, type, ticker, shares, price_per_share, amount, exchange_rate, amount_krw, dividend_used, cash_invested_krw) VALUES
-- TSLY 거래들
('2025-04-18', 'BUY', 'TSLY', 92.00000000, 8.26880000, 760.72960000, 1419.90, 1080159.00, 0.00000000, 1080159.00),
('2025-05-30', 'BUY', 'TSLY', 48.00000000, 9.58000000, 459.84000000, 1381.40, 635222.00, 0.00000000, 635222.00),
('2025-07-01', 'BUY', 'TSLY', 30.00000000, 8.26000000, 247.80000000, 1353.60, 335422.00, 0.00000000, 335422.00),
('2025-07-04', 'BUY', 'TSLY', 95.00000000, 7.82000000, 742.90000000, 1358.10, 1008932.00, 0.00000000, 1008932.00),
('2025-07-16', 'SELL', 'TSLY', -70.00000000, 7.76120000, -543.28400000, 1382.70, -751198.00, 0.00000000, 0.00),
('2025-07-25', 'SELL', 'TSLY', -195.00000000, 8.10000000, -1579.50000000, 1368.70, -2161861.00, 0.00000000, 0.00),

-- SMCY 거래들
('2025-04-25', 'BUY', 'SMCY', 25.00000000, 19.04000000, 476.00000000, 1430.20, 680775.00, 0.00000000, 680775.00),
('2025-07-16', 'BUY', 'SMCY', 33.00000000, 20.04000000, 661.32000000, 1382.70, 914407.00, 0.00000000, 914407.00),
('2025-07-24', 'BUY', 'SMCY', 40.00000000, 20.06000000, 802.40000000, 1379.10, 1106589.00, 0.00000000, 1106589.00),
('2025-07-25', 'BUY', 'SMCY', 27.00000000, 20.42000000, 551.34000000, 1368.70, 754619.00, 0.00000000, 754619.00),

-- NVDY 거래들
('2025-04-25', 'BUY', 'NVDY', 25.00000000, 14.42000000, 360.50000000, 1430.20, 515587.00, 0.00000000, 515587.00),
('2025-04-29', 'BUY', 'NVDY', 43.00000000, 14.17000000, 609.31000000, 1439.30, 876979.00, 0.00000000, 876979.00),
('2025-05-30', 'BUY', 'NVDY', 30.00000000, 15.33000000, 459.90000000, 1381.40, 635305.00, 0.00000000, 635305.00),
('2025-07-01', 'BUY', 'NVDY', 15.00000000, 16.68000000, 250.20000000, 1353.60, 338670.00, 0.00000000, 338670.00),
('2025-07-25', 'BUY', 'NVDY', 38.00000000, 16.54000000, 628.52000000, 1368.70, 860255.00, 0.00000000, 860255.00),

-- ULTY 거래들
('2025-07-21', 'BUY', 'ULTY', 57.00000000, 6.34500000, 361.66500000, 1391.90, 503401.00, 0.00000000, 503401.00),

-- QQQM 거래들
('2025-07-25', 'BUY', 'QQQM', 2.00000000, 231.56000000, 463.12000000, 1368.70, 633872.00, 0.00000000, 633872.00),

-- SPLG 거래들
('2025-07-25', 'BUY', 'SPLG', 4.00000000, 74.23000000, 296.92000000, 1368.70, 406394.00, 0.00000000, 406394.00);

-- 3. 배당금 데이터 입력 (dividends 테이블)
-- dollorList.csv의 외화증권배당금입금 거래 기반
INSERT INTO dividends (date, ticker, shares_held, amount, reinvested_amount, withdrawn_amount) VALUES
-- TSLY 배당금
('2025-04-21', 'TSLY', 92.00000000, 51.60000000, 0.00000000, 51.60000000),
('2025-05-20', 'TSLY', 92.00000000, 59.43000000, 0.00000000, 59.43000000),
('2025-06-16', 'TSLY', 140.00000000, 47.93000000, 0.00000000, 47.93000000),
('2025-07-14', 'TSLY', 265.00000000, 87.24000000, 0.00000000, 87.24000000),

-- SMCY 배당금
('2025-05-12', 'SMCY', 25.00000000, 30.02000000, 0.00000000, 30.02000000),
('2025-06-10', 'SMCY', 25.00000000, 33.57000000, 0.00000000, 33.57000000),
('2025-07-09', 'SMCY', 25.00000000, 34.22000000, 0.00000000, 34.22000000),

-- NVDY 배당금
('2025-04-29', 'NVDY', 25.00000000, 14.31000000, 0.00000000, 14.31000000),
('2025-05-28', 'NVDY', 68.00000000, 94.08000000, 0.00000000, 94.08000000),
('2025-06-23', 'NVDY', 98.00000000, 55.99000000, 0.00000000, 55.99000000),
('2025-07-21', 'NVDY', 113.00000000, 98.79000000, 0.00000000, 98.79000000);

-- 4. 데이터 검증 쿼리
SELECT 'EXCHANGE_RATES' as table_name, COUNT(*) as row_count FROM exchange_rates
UNION ALL
SELECT 'TRANSACTIONS' as table_name, COUNT(*) as row_count FROM transactions
UNION ALL
SELECT 'DIVIDENDS' as table_name, COUNT(*) as row_count FROM dividends
UNION ALL
SELECT 'HOLDINGS' as table_name, COUNT(*) as row_count FROM holdings;

-- 5. Investment Summary
SELECT 
    'Investment Summary' as info,
    SUM(CASE WHEN type = 'BUY' THEN amount_krw ELSE 0 END) as total_invested_krw,
    SUM(CASE WHEN type = 'BUY' THEN amount ELSE 0 END) as total_invested_usd,
    SUM(CASE WHEN type = 'SELL' THEN amount ELSE 0 END) as total_sold_usd
FROM transactions;

SELECT 
    'Dividend Summary' as info,
    SUM(amount) as total_dividends_usd,
    COUNT(*) as dividend_count
FROM dividends;

-- ===================================================
-- 주의: 이 스크립트 실행 후 holdings 테이블 재계산 필요
-- API 호출: GET /populate-holdings
-- ===================================================